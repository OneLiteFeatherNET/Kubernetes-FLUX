apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: otis
  namespace: otis
spec:
  values:
    image:
      repository: harbor.onelitefeather.dev/otis/otis
      pullPolicy: IfNotPresent
      tag: "1.6.0"
    imagePullSecrets:
      - name: harbor-pull
    service:
      port: 8080
    ingress:
      enabled: true
      className: traefik
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        kubernetes.io/ingress.class: traefik
        traefik.ingress.kubernetes.io/router.tls: "true"
        traefik.ingress.kubernetes.io/router.middlewares: otis-basic-auth@kubernetescrd,otis-ip-allowlist@kubernetescrd,otis-redirect-https@kubernetescrd
      # kubernetes.io/ingress.class: nginx
      # kubernetes.io/tls-acme: "true"

      hosts:
        - host: otis.apps.onelitefeather.dev
          paths:
            - path: /
              pathType: ImplementationSpecific
      tls:
        - secretName: otis-apps-onelitefeather-dev-tls
          hosts:
            - otis.apps.onelitefeather.dev
    profiles: [ "prod" ]

    config:
      base: |-
        micronaut:
          application:
            name: otis
      profiles:
        prod: |-
          datasources:
            default:
              url: $${JDBC_URL}
              username: $${DB_USER}
              password: $${DB_PASS}
              dialect: MYSQL
              driverClassName: org.mariadb.jdbc.Driver
              schema-generate: NONE
    envFrom:
      - secretRef:
          name: otis-app-db

    readinessProbe:
      path: /health
      initialDelaySeconds: 5
      periodSeconds: 5
    livenessProbe:
      path: /health
      initialDelaySeconds: 15
      periodSeconds: 10