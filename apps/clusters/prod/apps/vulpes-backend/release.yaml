apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: vulpes-backend
  namespace: vulpes
spec:
  values:
    image:
      repository: harbor.onelitefeather.dev/vulpes/vulpes-backend
      pullPolicy: IfNotPresent
      tag: "1.2.0-beta.11"
    imagePullSecrets:
      - name: harbor-pull
    service:
      port: 8085
    ingress:
      enabled: true
      className: traefik
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        kubernetes.io/ingress.class: traefik
        traefik.ingress.kubernetes.io/router.tls: "true"
        traefik.ingress.kubernetes.io/router.middlewares: vulpes-basic-auth@kubernetescrd,vulpes-ip-allowlist@kubernetescrd,vulpes-redirect-https@kubernetescrd
      # kubernetes.io/ingress.class: nginx
      # kubernetes.io/tls-acme: "true"

      hosts:
        - host: vulpes-backend.apps.onelitefeather.dev
          paths:
            - path: /
              pathType: ImplementationSpecific
      tls:
        - secretName: vulpes-backend-apps-onelitefeather-dev-tls
          hosts:
            - vulpes-backend.apps.onelitefeather.dev
    profiles: [ "prod" ]

    config:
      base: |-
        micronaut:
          application:
            name: Vulpes Backend
      profiles:
        prod: |-
          datasources:
            default:
              dialect: MYSQL
              url: $${JDBC_URL}
              username: $${DB_USER}
              password: $${DB_PASS}
              schema-generate: NONE
    envFrom:
      - secretRef:
          name: vulpes-app-db

    readinessProbe:
      path: /health
      initialDelaySeconds: 5
      periodSeconds: 5
    livenessProbe:
      path: /health
      initialDelaySeconds: 15
      periodSeconds: 10